# BooTools 架构文档

## 核心理念
BooTools 的核心是一个轻量级启动器，所有功能均通过可远程管理的独立插件提供。这种设计将主程序与功能完全解耦，提供了极高的灵活性和可扩展性。

## 插件系统核心

#### 1. 插件接口 (`IPlugin`)
所有插件都必须实现 `IPlugin` 接口，该接口定义了插件的生命周期（初始化、启动、停止、卸载）和基本交互（如显示设置界面）。

#### 2. 插件元数据 (`PluginMetadata`)
每个插件都有一个 `manifest.json` 文件，用于描述其元数据，如唯一ID、版本、作者、依赖项和主程序兼容性等。这是插件管理系统的重要数据来源。

#### 3. 插件隔离 (`AssemblyLoadContext`)
为了从根本上解决依赖冲突并实现热插拔，每个插件都在其自己的 `AssemblyLoadContext` 中加载。这创建了一个沙箱环境，使得插件及其依赖项与主程序和其他插件完全隔离，可以在运行时被安全地加载和卸载。

#### 4. 插件包格式 (`.bpkg`)
插件以 `.bpkg` 格式分发，这是一种标准的 ZIP 压缩包，包含：
- `manifest.json`: 插件元数据。
- `lib/`: 插件的程序集（DLLs）。
- `content/`: 图标、本地化文件等静态资源。
- `signature.xml`: 用于安全验证的数字签名。

---

## 插件设计规范
为确保插件生态的统一性、健壮性和可维护性，所有插件开发都必须遵循以下设计标准：

#### 1. 逻辑与UI分离
这是插件设计的核心原则。
- **插件主类**: 作为业务逻辑的核心，负责处理数据、状态管理、文件操作和所有非UI相关的任务。
- **设置窗体**: 作为一个“哑”视图，仅负责UI的展示和用户输入的捕获。它通过构造函数接收插件主类的实例，并调用其方法来响应用户操作。

#### 2. UI代码构建
所有插件的窗体和UI控件**必须**通过纯代码的方式创建和布局，**严禁使用** WinForms 的可视化设计器（即不应存在 `.designer.cs` 文件）。这确保了UI代码的一致性和可维护性。

#### 3. 标准化项目引用
为了避免核心库的版本冲突，插件项目在引用 `BooTools.Core` 时，**必须**在 `.csproj` 文件中将其配置为不复制到本地输出目录。
```xml
<ProjectReference Include="..\..\BooTools.Core\BooTools.Core.csproj">
  <Private>false</Private>
  <CopyLocal>false</CopyLocal>
</ProjectReference>
```

> 更详细的规范请参考《插件开发指南.md》。

---

## 远程管理系统
这是实现插件自动化管理的核心，由多个协同工作的服务组成：

- **仓库管理器 (`PluginRepositoryManager`)**: 负责从一个或多个远程仓库（如 GitHub Releases 或自定义的 HTTP API）获取可用的插件列表和版本信息。
- **下载管理器 (`PluginDownloadManager`)**: 以异步方式处理插件包的下载，支持进度跟踪和断点续传。
- **包管理器 (`PluginPackageManager`)**: 负责 `.bpkg` 包的安装与卸载。在安装前，它会校验包的完整性和数字签名，确保插件未被篡改。
- **版本与更新管理器 (`UpdateManager`)**: 自动检查已安装插件的更新，处理版本比较、兼容性检查，并执行安全可靠的更新流程（包括备份、替换和失败回滚）。

## 安全机制
为了确保插件生态的安全，系统在安装或更新插件时，会通过 `PluginPackageManager` 自动执行以下安全检查：
1.  **完整性校验**: 确保插件包在下载过程中没有损坏。
2.  **数字签名验证**: 使用 .NET 的加密库验证插件包内的 `signature.xml`。通过验证发布者的公钥证书和签名，确保插件来源可信且未被篡改。
