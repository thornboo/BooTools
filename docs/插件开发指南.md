# BooTools 插件开发指南

本文档旨在为希望为 BooTools 开发插件的第三方开发者提供一套清晰、统一的开发规范。遵循这些规范可以确保您的插件与 BooTools 主程序以及其他插件良好地兼容，并为用户提供一致、稳定的体验。

## 核心原则

BooTools 的插件架构遵循“**逻辑与UI分离**”的核心思想。插件本身是负责处理所有业务逻辑的“智能核心”，而其设置界面则是一个仅负责展示和用户交互的“哑视图”。

---

## 开发规范

### 1. 实现 `IPlugin` 接口

所有插件必须实现 `BooTools.Core.Interfaces.IPlugin` 接口。这是插件被 BooTools 识别和加载的技术基础。

```csharp
using BooTools.Core.Interfaces;
using BooTools.Core.Models;

public class MyAwesomePlugin : IPlugin
{
    public PluginMetadata Metadata { get; }
    public PluginStatus Status { get; }
    public event EventHandler<PluginStatusChangedEventArgs>? StatusChanged;

    public Task<PluginResult> InitializeAsync(IPluginContext context) { /* ... */ }
    public Task<PluginResult> StartAsync() { /* ... */ }
    public Task<PluginResult> StopAsync() { /* ... */ }
    public Task<PluginResult> UnloadAsync() { /* ... */ }
    public void ShowSettings() { /* ... */ }
    // ... 其他接口成员
}
```

### 2. 正确引用核心库

为了避免版本冲突和不必要的依赖冗余，插件项目在引用 `BooTools.Core` 核心库时，**必须**在 `.csproj` 项目文件中将引用配置为不复制到本地。

这可以确保所有插件都使用主程序提供的同一个 `BooTools.Core.dll` 实例。

**正确配置示例 (`.csproj`):**
```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWindowsForms>true</UseWindowsForms>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <!-- 这是必须遵守的关键配置 -->
    <ProjectReference Include="..\..\BooTools.Core\BooTools.Core.csproj">
      <Private>false</Private>
      <CopyLocal>false</CopyLocal>
    </ProjectReference>
  </ItemGroup>

</Project>
```

### 3. 逻辑与 UI 分离

这是保证插件架构清晰、可维护的关键。

- **插件主类 (e.g., `MyAwesomePlugin.cs`)**:
  - 负责所有业务逻辑，如文件读写、数据处理、定时任务、API调用等。
  - 管理插件自身的状态（例如，通过 `IPluginContext` 读写配置）。
  - 持有数据。

- **设置窗体 (e.g., `SettingsForm.cs`)**:
  - **不应**包含任何业务逻辑。
  - 通过构造函数接收插件主类的实例。
  - 从插件实例中获取数据并展示在UI上。
  - 将用户的操作（如点击按钮）委托给插件实例的公共方法来处理。

**示例:**
```csharp
// 在插件主类中
public class MyAwesomePlugin : IPlugin
{
    public string MyData { get; set; } = "Hello";

    public void UpdateData(string newData)
    {
        this.MyData = newData;
        // ... 执行保存配置等逻辑 ...
    }

    public void ShowSettings()
    {
        // 将自身实例传入窗体
        using (var form = new SettingsForm(this))
        {
            form.ShowDialog();
        }
    }
}

// 在设置窗体中
public class SettingsForm : Form
{
    private readonly MyAwesomePlugin _plugin;
    private readonly TextBox _textBox;

    public SettingsForm(MyAwesomePlugin plugin)
    {
        _plugin = plugin; // 保存插件实例的引用
        _textBox = new TextBox();
        
        // 从插件获取数据并展示
        _textBox.Text = _plugin.MyData; 

        var saveButton = new Button { Text = "Save" };
        saveButton.Click += (s, e) => {
            // 将用户操作委托给插件处理
            _plugin.UpdateData(_textBox.Text); 
            this.Close();
        };
    }
}
```

### 4. 统一 UI 构建方式

为了确保所有插件的UI代码风格和维护方式保持一致，所有插件的设置界面**必须**通过**纯代码**的方式来构建，**严禁使用** WinForms 的可视化设计器（即不应存在 `.designer.cs` 文件）。

请参考 `WallpaperSwitcher` 和 `EnvironmentVariableEditor` 插件中窗体的实现方式。

---

## 潜在挑战与建议

- **第三方依赖**: BooTools 使用 `AssemblyLoadContext` 来隔离插件依赖。尽管如此，我们仍建议您谨慎添加新的第三方库。如果主程序已经提供了某个库（如 `Newtonsoft.Json`），请优先考虑是否能直接使用。
- **UI/UX 风格**: 建议参考 BooTools 主程序和其他官方插件的界面风格，使用标准的 WinForms 控件，以保持视觉上的一致性。
- **安全性**: 插件将在主程序进程中运行。请确保您的代码是安全可靠的。未来，BooTools 可能会引入更严格的权限系统和沙箱机制。

感谢您为 BooTools 生态系统做出贡献！
